require_relative 'env'
require 'modules'

require_all 'payloads'

require 'rack/contrib'
require 'rack/csrf'

require 'sinatra/base'
require 'sinatra/config_file'
require 'sinatra/json'

require 'web/extensions/csrf_protection'
require 'web/helpers/options_helper'
require 'web/helpers/web_session_output_helper'
require 'web/models'
require 'web/controllers'

Dir.chdir('lib/web/public') do
  system 'npm install'
  system 'npm run typings:install'
  system 'npm run tsc'
end

map('/') { run Web::Controllers::Static }
map('/api') { run Web::Controllers::Base }
map('/api/module') { run Web::Controllers::Module }
map('/api/modules') { run Web::Controllers::Modules }
map('/api/payloads') { run Web::Controllers::Payloads }
map('/api/sessions') { run Web::Controllers::Sessions }

at_exit { Web::Controllers::Sessions.kill_active_sessions }
